import {
    WebViewInternalEventMessage,
    WebViewMessageEvent_MessageData,
} from '@devvit/protos/types/devvit/ui/events/v1alpha/web_view.js'; // to-do: use /json/ not /types/.
const EFFECTS_WITH_RESPONSE = [
    3,
    11,
];
/**
 * Emits an effect to the parent window and handles the response if required.
 *
 * @param effect - The effect to be emitted to the parent window
 * @returns A promise that resolves with the response message for effects that require
 *          a response, or resolves immediately with undefined for effects that don't
 *
 * @description
 * This function handles two types of effects:
 * 1. Effects that require a response: Creates a unique ID, sets up a message listener,
 *    and resolves the promise when a matching response is received
 * 2. Effects that don't require a response: Posts the message and resolves immediately
 */
export const emitEffect = (effect) => {
    return new Promise((resolve) => {
        const message = {
            scope: 0,
            type: 'devvit-internal',
        };
        if (effect.realtimeSubscriptions) {
            message.realtimeEffect = effect.realtimeSubscriptions;
        } else if (effect.immersiveMode) {
            message.immersiveMode = effect.immersiveMode;
        } else if (effect.share) {
            message.share = effect.share;
        } else {
            message.effect = effect;
        }
        // For temporary backward compatibility, we set both `message.effect` above, its types counterpart, below
        if (effect.showToast) {
            message.showToast = effect.showToast;
        } else if (effect.navigateToUrl) {
            message.navigateToUrl = effect.navigateToUrl;
        }
        // Only set message id and add a listener for effects which require a response
        if (EFFECTS_WITH_RESPONSE.includes(effect.type)) {
            const id = self.crypto.randomUUID();
            message.id = id;
            const handleEffect = (event) => {
                if (event.data ? .type === 'devvit-message' && event.data ? .data ? .id === id) {
                    const serializedMessage = WebViewInternalEventMessage.fromJSON(event.data.data);
                    resolve(serializedMessage);
                    window.removeEventListener('message', handleEffect);
                }
            };
            window.addEventListener('message', handleEffect);
            // Post message to the parent window, handled by client web view component
            window.parent.postMessage(message, '*');
        } else {
            window.parent.postMessage(message, '*');
            // Resolve immediately for effects that don't expect a response.
            resolve(undefined);
        }
    });
};